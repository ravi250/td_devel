#!/bin/bash

#
# Script to modify the Training Lab for testing long user names and long process_names
#
# Expectation in the filesystem:
#   Folder ${HOME} contains the folders
#      2_GCFR_Standard_Packages with the unzipped GCFR_DDL_Code subfolder
#      4_Objects_For_Exercises
#   The GCFR main node must have been created as "GCFR_MAIN"
#   No installation of GCFR in the database (this script will execute it)
#   Created linux folder /GCFR_Root with the GCFR installation and the
#      content from folder 3_Copy_to_GCFR_Root!
#

ts=$(date +"%Y%m%d-%H%M%S")

#
# default routine to delete temporary files after finish
# comment this command to keep the temporary files
#
trap "rm -f /tmp/*.${ts}.* >/dev/null 2>&1" EXIT

#
# First, generate the sed scripts for the replacements
#
{
    echo 's/([\, 	]Process_Name[ 	]+VARCHAR)\s*\(\s*30\s*\) /\1(128)/'
    echo 's/([\, 	]Update_Process_Name[ 	]+VARCHAR)\s*\(\s*30\s*\) /\1(128)/'
    echo 's/\bBK_001_01_ADDRESS_ID\b/BK_001_01_ADDRESS_ID123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBK_001_01_PARTY_ID\b/BK_001_01_PARTY_ID123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBK_002_02_ACCOUNT_ID\b/BK_002_02_ACCOUNT_ID123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBK_003_03_ACCOUNT_ID\b/BK_003_03_ACCOUNT_ID123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBK_003_03_EVENT_ID\b/BK_003_03_EVENT_ID123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_001_01_GENDER\b/BM_001_01_GENDER123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_001_01_MARITAL_STAT\b/BM_001_01_MARITAL_STAT123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_002_02_ACCT_ACT\b/BM_002_02_ACCT_ACT123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_002_02_ACCT_TYP\b/BM_002_02_ACCT_TYP123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_003_03_CHNL\b/BM_003_03_CHNL123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bBM_003_03_TRAN_CD\b/BM_003_03_TRAN_CD123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bEX_001_01_CUSTOMER\b/EX_001_01_CUSTOMER123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bEX_002_02_ACCOUNT\b/EX_002_02_ACCOUNT123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bEX_003_03_TRANSACTION\b/EX_003_03_TRANSACTION123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bFX_001_004_CUST_ACC\b/FX_001_004_CUST_ACC123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bLD_001_01_CUSTOMER\b/LD_001_01_CUSTOMER123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bLD_002_02_ACCOUNT\b/LD_002_02_ACCOUNT123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bLD_003_03_TRANSACTION\b/LD_003_03_TRANSACTION123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_001_01_CUSTOMER_ADDRESS\b/TX_001_01_CUSTOMER_ADDRESS123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_001_01_CUSTOMER_IND_NM\b/TX_001_01_CUSTOMER_IND_NM123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_001_01_CUSTOMER_INDIV\b/TX_001_01_CUSTOMER_INDIV123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_001_01_CUSTOMER_PARTY\b/TX_001_01_CUSTOMER_PARTY123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_001_01_CUSTOMER_SI\b/TX_001_01_CUSTOMER_SI123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_002_02_ACC_PARTY_ACC\b/TX_002_02_ACC_PARTY_ACC123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_002_02_ACCOUNT_ACCOUNTS\b/TX_002_02_ACCOUNT_ACCOUNTS123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_002_02_ACCOUNT_SI\b/TX_002_02_ACCOUNT_SI123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_003_03_TRANS_FIN_EVENT\b/TX_003_03_TRANS_FIN_EVENT123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
    echo 's/\bTX_003_03_TRANSACTION_SI\b/TX_003_03_TRANSACTION_SI123456789056789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY/g'
} >/tmp/sql.${ts}.sed

{
    echo 's/<TDBUSER>GDEV1_ETL_USR<\/TDBUSER>/<TDBUSER>GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW<\/TDBUSER>/'
    echo 's/<\/PROCESS_NAME>/1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890XY<\/PROCESS_NAME>/'
} >/tmp/xml.${ts}.sed

#
# Script to create a test user with a long name
#
{
    echo '.logon tddemo/dbc,dbc'

    echo 'CREATE USER GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW'
    echo '   FROM GCFR_MAIN'
    echo '   AS PASSWORD = GDEV1_ETL_USR'
    echo '   PERM = 0'
    echo '   DEFAULT ROLE = ALL'
    echo ';'

    echo '--'
    echo '-- for executing processes'
    echo '--'
    echo 'grant execute procedure        on GDEV1P_BB  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant execute procedure        on GDEV1P_CP  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant execute procedure        on GDEV1P_FF  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant execute procedure        on GDEV1P_PP  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant execute procedure        on GDEV1P_UT  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create table, drop table on GDEV1T_WRK to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select                   on GDEV1T_TMP to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'

    echo '--'
    echo '-- for registering metadata'
    echo '--'
    echo 'grant execute           on GDEV1M_GCFR  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant execute procedure on GDEV1P_UT    to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant insert            on GDEV1V_UTLFW to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'

    echo '--'
    echo '-- for deploying objects'
    echo '--'
    echo 'grant create table, drop table on GDEV1T_STG   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create table, drop table on GDEV1T_SRCI  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create table, drop table on GDEV1T_BASE  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create table, drop table on GDEV1T_UTLFW to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_STG   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_SRCI  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_BASE  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_UTLFW to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_INP   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant create view, drop view   on GDEV1V_OUT   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'

    echo 'grant select on GDEV1V_STG   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select on GDEV1V_SRCI  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select on GDEV1V_BASE  to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select on GDEV1V_UTLFW to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select on GDEV1V_INP   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
    echo 'grant select on GDEV1V_OUT   to GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW;'
} >/tmp/create_test_user.${ts}.sql

#
# Execute manipulation of XML files
#
cd /GCFR_Root/app/etc
sed -i -f /tmp/xml.${ts}.sed *.xml
if [ $? -ne 0 ]
then
    echo "Error while manipulating the XML files"
    exit 1
fi

#
# Execute manipulation of Training Lab Objects
#
cd ${HOME}/4_Objects_For_Exercises
sed -i -f /tmp/sql.${ts}.sed *.sql *.bteq
if [ $? -ne 0 ]
then
    echo "Error while manipulating the SQL and BTEQ files for the Training Lab"
    exit 2
fi

#
# Execute manipulation of run_all.bteq script to change logon from dbc to the newly create user
#
sed -i 's/.logon tddemo\/dbc,dbc/.logon tddemo\/GDEV1_ETL_USR_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_123456789_ZYXW,GDEV1_ETL_USR/' run_all.bteq
if [ $? -ne 0 ]
then
    echo "Error while manipulating the run_all.bteq to install Training Lab Objects!"
    exit 3
fi

#
# Installation of GCFR in the database
#
cd ${HOME}/2_GCFR_Standard_Packages/GCFR_DDL_Code/GCFR_Implementation_Kit
echo "" | sh runme.sh
RC=${PIPESTATUS[1]}
if [ ${RC} -ne 0 ]
then
    echo "Installation of GCFR in database failed!"
    exit 4
fi

#
# Execute creation of test user with long name
#
bteq </tmp/create_test_user.${ts}.sql
if [ $? -ne 0 ]
then
    echo "Error while creating test user with long name!"
    exit 5
fi

#
# Execute installation of Training Lab Objects
#
cd ${HOME}/4_Objects_For_Exercises
bteq <run_all.bteq
if [ $? -ne 0 ]
then
    echo "Error while creating GCFR Training Lab Objects!"
    exit 6
fi
